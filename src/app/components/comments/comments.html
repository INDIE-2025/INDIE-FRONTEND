
<div class="comments">
  @if (idUsuarioComentador) {
    <div class="comments__form">
      <form [formGroup]="form" (ngSubmit)="enviar()">
        <textarea
          class="comments__textarea"
          formControlName="comentario"
          rows="3"
          placeholder="Escribe un comentario…"
          [disabled]="posting"
        ></textarea>
        <!-- Fila inferior: errores + botón -->
        <div class="comments__form-row">
          <div class="comments__errors">
            <!-- Error si el control fue tocado y falta el requerido -->
            @if (f['comentario'].touched && f['comentario'].hasError('required')) {
              <span class="error">
                El comentario es obligatorio.
              </span>
            }
            @if (f['comentario'].touched && f['comentario'].hasError('maxlength')) {
              <span class="error">
                Máximo 1000 caracteres.
              </span>
            }
            @if (errorMsg) {
              <span class="error">{{ errorMsg }}</span>
            }
          </div>
          <!-- Botón de publicar: deshabilitado si el form es inválido o está posteando -->
          <button class="btn" type="submit" [disabled]="form.invalid || posting">
            {{ posting ? 'Publicando…' : 'Publicar' }}
          </button>
        </div>
      </form>
    </div>
  } @else {
    <div class="comments__login-hint">
      Iniciá sesión para agregar un comentario.
    </div>
  }

  <!-- Si no hay idUsuarioComentador, muestra el aviso de login -->

  <!-- Lista de comentarios -->
  <div class="comments__list">
    <!-- Estado de carga -->
    @if (loadingList) {
      <div class="comments__loading">Cargando comentarios…</div>
    }

    <!-- Mensaje cuando no hay comentarios -->
    @if (!loadingList && comentarios.length === 0) {
      <div class="comments__empty">
        Sé la primera persona en comentar
      </div>
    }

    <!-- Renderiza cada comentario -->
    @for (c of comentarios; track c) {
      <article class="comment">
        <!-- Avatar: primera letra del nombre del autor -->
        <div class="comment__avatar" aria-hidden="true">
          {{ (c.nombreAutorComentario || 'U')[0] | uppercase }}
        </div>
        <!-- Cuerpo del comentario -->
        <div class="comment__body">
          <!-- Encabezado con autor + fecha -->
          <header class="comment__meta">
            <strong class="comment__author">{{ c.nombreAutorComentario || 'Usuario' }}</strong>
            <span class="comment__date">• {{ c.createdAt | date: 'short' }}</span>
          </header>
          <!-- Texto del comentario -->
          <p class="comment__text">{{ c.comentario }}</p>
          <!-- ===== OPCIONAL: acciones por comentario (eliminar/denunciar) ===== -->
          <div class="comment__actions">
            <!-- solo el autor puede eliminar -->
            @if (c.idUsuarioComentador === idUsuarioComentador) {
              <button class="comment__link" (click)="eliminar(c)">
                Eliminar
              </button>
            }
            <!-- cualquier usuario puede denunciar -->
            <button class="comment__link" (click)="denunciar(c)">
              Denunciar
            </button>
          </div>
        </div>
      </article>
    }
  </div>
</div>
