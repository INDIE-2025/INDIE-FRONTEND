<div class="new-password-container">
  <div class="left-panel">
    <div class="brand">
      <h1 class="brand-title">INDIE</h1>
      <p class="brand-subtitle">La plataforma definitiva para descubrir la mejor escena independiente</p>
      <div class="security-alert">
        <mat-icon class="icon">security</mat-icon>
        <p>Por tu seguridad, este enlace de recuperación es válido por 1 hora.</p>
      </div>
    </div>
  </div>

  <div class="right-panel">
    <div class="new-password-card">
      <!-- Token invalido o expirado -->
      @if (!isValidToken) {
        <div class="invalid-token-message">
          <div class="error-icon">
            <mat-icon>error_outline</mat-icon>
          </div>
          <h2>Token Inválido</h2>
          <p>{{ errorMessage }}</p>
          <p>Por favor, solicita un nuevo enlace de recuperación de contraseña.</p>

          <div class="form-footer">
            <p><a routerLink="/password-recovery" class="link">Solicitar nuevo enlace</a></p>
            <p><a routerLink="/login" class="link">Volver al inicio de sesión</a></p>
          </div>
        </div>
      }

      <!-- Formulario de nueva contraseña -->
      @if (isValidToken && !isPasswordReset) {
        <div class="new-password-form">
          <div class="form-header">
            <h2>Nueva Contraseña</h2>
            <p>Crea una nueva contraseña segura para tu cuenta</p>
          </div>

          <form [formGroup]="newPasswordForm" (ngSubmit)="onSubmit()">
            <div class="form-group">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Nueva Contraseña</mat-label>
                <mat-icon matPrefix class="icon">lock</mat-icon>
                <input
                  matInput
                  [type]="isPasswordVisible ? 'text' : 'password'"
                  formControlName="password"
                  placeholder="Ingresa tu nueva contraseña"
                  autocomplete="new-password">
                <button
                  mat-icon-button
                  matSuffix
                  type="button"
                  (click)="togglePasswordVisibility()"
                  [attr.aria-label]="isPasswordVisible ? 'Ocultar contraseña' : 'Mostrar contraseña'">
                  <mat-icon>{{ isPasswordVisible ? 'visibility_off' : 'visibility' }}</mat-icon>
                </button>
                @if (newPasswordForm.get('password')?.invalid && newPasswordForm.get('password')?.touched) {
                  <mat-error>
                    {{ getPasswordErrorMessage() }}
                  </mat-error>
                }
              </mat-form-field>
            </div>

            <div class="form-group">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Confirmar Contraseña</mat-label>
                <mat-icon matPrefix class="icon">lock_outline</mat-icon>
                <input
                  matInput
                  [type]="isConfirmPasswordVisible ? 'text' : 'password'"
                  formControlName="confirmPassword"
                  placeholder="Confirma tu nueva contraseña"
                  autocomplete="new-password">
                <button
                  mat-icon-button
                  matSuffix
                  type="button"
                  (click)="toggleConfirmPasswordVisibility()"
                  [attr.aria-label]="isConfirmPasswordVisible ? 'Ocultar contraseña' : 'Mostrar contraseña'">
                  <mat-icon>{{ isConfirmPasswordVisible ? 'visibility_off' : 'visibility' }}</mat-icon>
                </button>
                @if (newPasswordForm.get('confirmPassword')?.invalid && newPasswordForm.get('confirmPassword')?.touched) {
                  <mat-error>
                    {{ getConfirmPasswordErrorMessage() }}
                  </mat-error>
                }
              </mat-form-field>
            </div>

            <div class="password-requirements">
              <h4>La contraseña debe contener:</h4>
              <ul>
                <li [class.valid]="hasMinLength()">
                  <mat-icon>{{ hasMinLength() ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                  Al menos 8 caracteres
                </li>
                <li [class.valid]="hasUppercase()">
                  <mat-icon>{{ hasUppercase() ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                  Una letra mayúscula
                </li>
                <li [class.valid]="hasLowercase()">
                  <mat-icon>{{ hasLowercase() ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                  Una letra minúscula
                </li>
                <li [class.valid]="hasNumber()">
                  <mat-icon>{{ hasNumber() ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                  Un número
                </li>
                <li [class.valid]="hasSpecialChar()">
                  <mat-icon>{{ hasSpecialChar() ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                  Un símbolo (@$!%*?)
                </li>
              </ul>
            </div>

            <!-- Mensaje de error general -->
            @if (errorMessage) {
              <div class="error-message">
                <mat-icon>error</mat-icon>
                <span>{{ errorMessage }}</span>
              </div>
            }

            <button
              type="submit"
              [disabled]="!newPasswordForm.valid || isLoading"
              class="submit-btn"
              mat-raised-button
              color="primary"
            >
              @if (isLoading) {
                <span>Actualizando...</span>
              } @else {
                <span>Actualizar Contraseña</span>
              }
            </button>

            <div class="form-footer">
              <p><a routerLink="/login" class="link">Volver al inicio de sesión</a></p>
            </div>
          </form>
        </div>
      }

      <!-- Mensaje de éxito -->
      @if (isPasswordReset) {
        <div class="success-message">
          <div class="success-icon">
            <mat-icon>check_circle</mat-icon>
          </div>
          <h2>Contraseña Actualizada!</h2>
          <p>Tu contraseña ha sido cambiada exitosamente.</p>
          <p>Serás redirigido al inicio de sesión en unos segundos...</p>

          <div class="form-footer">
            <p><a routerLink="/login" class="link">Ir al inicio de sesión ahora</a></p>
          </div>
        </div>
      }
    </div>
  </div>
</div>
